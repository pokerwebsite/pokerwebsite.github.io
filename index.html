<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <style>
        body { 
            margin:0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
            min-height:100vh; 
            position:relative; 
            background: linear-gradient(135deg, #0d7a3d 0%, #0a5a2e 100%);
            background-attachment: fixed;
        }
        .screen { 
            position:absolute; 
            inset:0; 
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            justify-content:flex-start; 
            padding:24px; 
            background:transparent; 
            opacity:0; 
            pointer-events:none; 
            transition:opacity 300ms ease; 
        }
        .screen.active { opacity:1; pointer-events:auto; }
        
        /* Username screen larger */
        #usernamePage { gap:12px; display:flex; align-items:center; justify-content:center; }
        #usernamePage h2 { 
            font-size:32px; 
            margin:0; 
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        #usernamePage input { 
            font-size:18px; 
            padding:12px 16px; 
            width:360px; 
            border: 2px solid #0a5a2e;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        #usernamePage button, #btnSet {
            font-size: 18px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #d4af37 0%, #b8941a 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #usernamePage button:hover, #btnSet:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        #usernamePage button:active, #btnSet:active {
            transform: translateY(0);
        }

        /* Lobby centered and larger controls */
        #lobbyScreen { gap:12px; justify-content:center; align-items:center; }
        #lobbyScreen .lobbyControls { display:flex; gap:12px; align-items:center; font-size:18px; }
        #lobbyScreen .lobbyControls button { 
            font-size:16px; 
            padding:10px 20px; 
            background: linear-gradient(135deg, #d4af37 0%, #b8941a 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #lobbyScreen .lobbyControls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        #lobbyScreen .lobbyControls input { 
            font-size:16px; 
            padding:10px 16px; 
            border: 2px solid #0a5a2e;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        #gameScreen { gap:12px; }
        
        /* Start button and waiting text positioning */
        #startGameButton, #waitingForHost {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2000;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #startGameButton {
            background: linear-gradient(135deg, #d4af37 0%, #b8941a 100%);
            color: #fff;
            cursor: pointer;
        }
        
        #startGameButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
        }
        
        #startGameButton:active {
            transform: translateY(0);
        }
        
        #waitingForHost {
            background: rgba(255, 255, 255, 0.95);
            color: #0a5a2e;
            padding: 12px 20px;
        }
        
        #gameCodeDisplay {
            position: fixed;
            top: 70px;
            left: 20px;
            z-index: 2000;
            background: rgba(255, 255, 255, 0.95);
            color: #0a5a2e;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* Button styling improvements */
        button:not(#startGameButton):not(#waitingForHost) {
            background: linear-gradient(135deg, #d4af37 0%, #b8941a 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:not(#startGameButton):not(#waitingForHost):hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #999;
        }
        
        input[type="number"], input[type="text"] {
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 10px 14px;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        /* Table visualization styles */
        #pokerTable {
            position: relative;
            width: 600px;
            height: 400px;
            margin: 20px auto;
        }
        
        .table-surface {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 250px;
            background: linear-gradient(135deg, #1a5c2e 0%, #0d3d1f 100%);
            border: 8px solid #8B4513;
            border-radius: 50%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 50px rgba(0,0,0,0.3);
        }
        
        .table-pot {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: 700;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }
        
        .player-seat {
            position: absolute;
            background: rgba(255,255,255,0.95);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            color: #0a5a2e;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            min-width: 100px;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .player-seat.current-turn {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: 2px solid #ffb800;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 4px 12px rgba(0,0,0,0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 4px 12px rgba(0,0,0,0.3);
            }
            to {
                box-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 4px 12px rgba(0,0,0,0.3);
            }
        }
        
        .player-seat.chip-added {
            animation: chipPulse 0.6s ease-out;
        }
        
        @keyframes chipPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        
        .player-seat.user-seat {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: #fff;
            border: 2px solid #2a6fa8;
        }
    </style>

    <div id="usernamePage" class="screen active">
        <h2>Set Username</h2>
        <input type="text" id="txtUsername" placeholder="Enter username">
        <button id="btnSet">Set Username</button>
    </div>

    <div id="lobbyScreen" class="screen" style="display:flex;">
        <div class="lobbyControls">
            <button id="btnCreate">New Game</button>
            <button id="btnJoin">Join Game</button>
            <input type="text" id="txtGameId" placeholder="Game ID">
        </div>
        <div id="divPlayers" style="margin-top:18px; width:100%; max-width:640px;"></div>
    </div>

    <div id="gameScreen" class="screen">
        <div id="divBoard" style="width:100%; max-width:900px; min-height:240px;"></div>
    </div>

    <script>
        //HTML elements
        let clientId = null;
        let gameId = null;
        let playerColor = null;
        let username = null;
        let pot = 0;
        let ws = new WebSocket("https://server-nks4.onrender.com")
        const btnCreate = document.getElementById("btnCreate");
        const btnJoin = document.getElementById("btnJoin");
        const txtGameId = document.getElementById("txtGameId");
        const divPlayers = document.getElementById("divPlayers");
        const divBoard = document.getElementById("divBoard");
        let messagesContainer = null; // created only when player is in the game
        const txtUsername = document.getElementById("txtUsername");
        const btnSet = document.getElementById("btnSet");
        const usernamePage = document.getElementById("usernamePage");
        let amountAdded = 0;
        let prevRound = null;
        
        // screen switching helper (username, lobby, game)
        function showScreen(id){
            const screens = document.querySelectorAll('.screen');
            screens.forEach(s => s.classList.remove('active'));
            const target = document.getElementById(id);
            if (target) {
                target.classList.add('active');
                // minor focus management
                const input = target.querySelector('input');
                if (input) input.focus();
            }
        }
    
        //wiring events
        btnJoin.addEventListener("click", e => {

            if (gameId === null)
                gameId = txtGameId.value;
            
            const payLoad = {
                "method": "join",
                "clientId": clientId,
                "gameId": gameId,
                "name": username
            }

            ws.send(JSON.stringify(payLoad));

        })
        btnSet.addEventListener("click", e => {
            const val = txtUsername.value && txtUsername.value.trim();
            if (!val) {
                showError("Please enter a username");
                return;
            }
            username = val;
            showScreen('lobbyScreen');
        })
        btnCreate.addEventListener("click", e => {

            const payLoad = {
                "method": "create",
                "clientId": clientId
            }

            ws.send(JSON.stringify(payLoad));

        })

        ws.onmessage = message => {
            //message.data
            const response = JSON.parse(message.data);
            //connect
            if (response.method === "connect"){
                clientId = response.clientId;
                console.log("Client id Set successfully " + clientId)
            }
            

            //create
            if (response.method === "create"){
                gameId = response.game.id;
                console.log("game successfully created with id " + response.game.id + " with " + response.game.balls + " balls")  
                const payLoad = {
                "method": "join",
                "clientId": clientId,
                "gameId": response.game.id,
                "name": username
                }
                ws.send(JSON.stringify(payLoad));
            }
            //error
            if (response.method === "error"){
                showError(response.error);
                console.log(response.amountadded)
                return;
            }


            //update: expect a single numeric value for the game
            if (response.method === "update"){
                const game = response.game || {};
                let value = null;
                if (typeof game.value === 'number') value = game.value;
                else if (typeof game.state === 'number') value = game.state;
                else if (game.state && typeof game.state.value === 'number') value = game.state.value;
                const display = document.getElementById('numberDisplay');
                if (value !== null && value !== undefined && display) display.textContent = String(value);
                console.log(game.max)
                // update round and turn if present
                const roundDisplay = document.getElementById('roundDisplay');
                const turnDisplay = document.getElementById('turnDisplay');
                if (roundDisplay) roundDisplay.textContent = 'Round: ' + (game.round || 0) + ' / ' + (game.totalRounds || 0);
                if (turnDisplay) turnDisplay.textContent = 'Turn: ' + (game.currentTurnName || '');

                // reset local per-round added counters if round changed
                if (typeof game.round === 'number' && prevRound !== game.round){
                    amountAdded = 0;
                    const yourAddedDisplay = document.getElementById('yourAddedDisplay');
                    if (yourAddedDisplay) yourAddedDisplay.textContent = 'You added: 0';
                    const addInput = document.getElementById('addInput');
                    if (addInput) addInput.value = '';
                    prevRound = game.round;
                }

                // display target (game.max) and per-client added amounts
                const target = typeof game.max === 'number' ? game.max : 0;
                const maxDisplay = document.getElementById('maxDisplay');
                if (maxDisplay) maxDisplay.textContent = 'Target: ' + target;

                const requiredAddDisplay = document.getElementById('requiredAddDisplay');
                const yourAddedDisplay = document.getElementById('yourAddedDisplay');
                const yourChipsValue = document.getElementById('yourChipsValue');
                const myAdded = (game.amountsAdded && typeof game.amountsAdded[clientId] === 'number') ? game.amountsAdded[clientId] : 0;
                const required = Math.max(0, target - myAdded);
                if (requiredAddDisplay) requiredAddDisplay.textContent = 'To add: ' + required;
                if (yourAddedDisplay) yourAddedDisplay.textContent = 'You added: ' + myAdded;
                const myChips = (game.chips && typeof game.chips[clientId] === 'number') ? game.chips[clientId] : 0;
                if (yourChipsValue) yourChipsValue.textContent = String(myChips);
                
                // Update player list
                updatePlayerList(game);

                // create/show messages only if this client is in the game
                const amIInGame = Array.isArray(game.clients) && game.clients.some(c => c.clientId === clientId);
                if (amIInGame) {
                    ensureMessagesContainer();
                    if (Array.isArray(game.messages)) renderMessages(game.messages);
                    // update turn indicator (only if game has started)
                    if (game.started) {
                        updateTurnIndicator(game.currentTurnName || '');
                    } else {
                        removeTurnIndicator();
                    }
                    // community area
                    ensureCommunityContainer();
                    if (Array.isArray(game.community)) renderCommunity(game.community, game.round);
                    // show chips widget
                    ensureYourChipsContainer();
                    updatePlayerList(game);
                    const vElm = document.getElementById('yourChipsValue');
                    if (vElm) vElm.textContent = String((game.chips && typeof game.chips[clientId] === 'number') ? game.chips[clientId] : 0);
                    // show blind notice on start if applicable
                    const sbIndexStart = typeof game.smallBlindIndex === 'number' ? game.smallBlindIndex : null;
                    const bbIndexStart = typeof game.bigBlindIndex === 'number' ? game.bigBlindIndex : null;
                    const sbIdStart = (Array.isArray(game.clients) && sbIndexStart !== null && game.clients[sbIndexStart]) ? game.clients[sbIndexStart].clientId : null;
                    const bbIdStart = (Array.isArray(game.clients) && bbIndexStart !== null && game.clients[bbIndexStart]) ? game.clients[bbIndexStart].clientId : null;
                    // Only show blind notices in first round
                    const currentRound = typeof game.round === 'number' ? game.round : 0;
                    if (currentRound <= 1) {
                        if (clientId === bbIdStart) { showBlindNotice('You are the Big Blind'); }
                        else if (clientId === sbIdStart) { showBlindNotice('You are the Small Blind'); }
                        else { clearBlindNotice(); }
                        // show blind notice if this client is small or big blind
                        const sbIndex = typeof game.smallBlindIndex === 'number' ? game.smallBlindIndex : null;
                        const bbIndex = typeof game.bigBlindIndex === 'number' ? game.bigBlindIndex : null;
                        const sbId = (Array.isArray(game.clients) && sbIndex !== null && game.clients[sbIndex]) ? game.clients[sbIndex].clientId : null;
                        const bbId = (Array.isArray(game.clients) && bbIndex !== null && game.clients[bbIndex]) ? game.clients[bbIndex].clientId : null;
                        if (clientId === bbId) {
                            showBlindNotice('You are the Big Blind');
                        } else if (clientId === sbId) {
                            showBlindNotice('You are the Small Blind');
                        } else {
                            clearBlindNotice();
                        }
                    } else {
                        clearBlindNotice();
                    }
                } else {
                    removeMessagesContainer();
                    removeTurnIndicator();
                    removeCommunityContainer();
                    removeYourChipsContainer();
                }

                // enable/disable inputs based on turn and gray them out
                const addInput = document.getElementById('addInput');
                const addBtn = document.getElementById('addBtn');
                const checkBtn = document.getElementById('checkBtn');
                const foldBtn = document.getElementById('foldBtn');
                const isMyTurn = (() => {
                    if (!game.started || game.ended) return false;
                    const ti = typeof game.turnIndex === 'number' ? game.turnIndex : 0;
                    const current = (game.clients || [])[ti];
                    return current && current.clientId === clientId;
                })();
                
                // Check if player can check (their amountAdded equals the max)
                const myAddedForCheck = (game.amountsAdded && typeof game.amountsAdded[clientId] === 'number') ? game.amountsAdded[clientId] : 0;
                const targetForCheck = typeof game.max === 'number' ? game.max : 0;
                const canCheck = myAddedForCheck >= targetForCheck;
                
                if (addInput) {
                    addInput.disabled = !isMyTurn;
                    addInput.min = Math.max(1, required);
                    addInput.style.background = addInput.disabled ? 'rgba(238,238,238,0.7)' : 'rgba(255,255,255,0.95)';
                    addInput.style.opacity = addInput.disabled ? '0.6' : '1';
                }
                if (addBtn) {
                    addBtn.disabled = !isMyTurn;
                    addBtn.style.opacity = addBtn.disabled ? '0.6' : '1';
                }
                if (checkBtn) {
                    checkBtn.disabled = !isMyTurn || !canCheck;
                    checkBtn.style.opacity = (!isMyTurn || !canCheck) ? '0.6' : '1';
                }
                if (foldBtn) {
                    foldBtn.disabled = !isMyTurn;
                    foldBtn.style.opacity = foldBtn.disabled ? '0.6' : '1';
                }
            }

            //start: server signals that the game has started; render numeric UI
            if (response.method === "start"){
                const game = response.game || {};
                // Remove start button and waiting text when game starts
                const existingStartBtn = document.getElementById('startGameButton');
                const existingWaiting = document.getElementById('waitingForHost');
                const existingGameCode = document.getElementById('gameCodeDisplay');
                if (existingStartBtn) existingStartBtn.remove();
                if (existingWaiting) existingWaiting.remove();
                if (existingGameCode) existingGameCode.remove();
                // clear board and controls overlay
                while(divBoard.firstChild) divBoard.removeChild(divBoard.firstChild);
                removeControlsOverlay();

                // ensure board positioning for centered pot
                divBoard.style.position = 'center';
                divBoard.style.minHeight = '360px';

                const numberContainer = document.createElement('div');
                numberContainer.style.position = 'absolute';
                numberContainer.style.top = '30%';
                numberContainer.style.left = '50%';
                numberContainer.style.transform = 'translate(-50%, -50%)';
                numberContainer.style.display = 'flex';
                numberContainer.style.flexDirection = 'column';
                numberContainer.style.alignItems = 'center';
                numberContainer.style.gap = '10px';
                const headerRow = document.createElement('div');
                headerRow.style.display = 'flex';
                headerRow.style.gap = '16px';
                headerRow.style.flexWrap = 'wrap';
                headerRow.style.justifyContent = 'center';
                headerRow.style.padding = '12px';
                headerRow.style.background = 'rgba(255,255,255,0.1)';
                headerRow.style.borderRadius = '8px';
                headerRow.style.marginBottom = '8px';

                const roundDisplay = document.createElement('div');
                roundDisplay.id = 'roundDisplay';
                roundDisplay.textContent = 'Round: ' + (game.round || 0) + ' / ' + (game.totalRounds || 0);
                roundDisplay.style.color = '#fff';
                roundDisplay.style.fontWeight = '600';
                roundDisplay.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)';
                headerRow.appendChild(roundDisplay);

                const turnDisplay = document.createElement('div');
                turnDisplay.id = 'turnDisplay';
                turnDisplay.textContent = 'Turn: ' + (game.currentTurnName || '');
                turnDisplay.style.color = '#fff';
                turnDisplay.style.fontWeight = '600';
                turnDisplay.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)';
                headerRow.appendChild(turnDisplay);

                const requiredAddDisplay = document.createElement('div');
                requiredAddDisplay.id = 'requiredAddDisplay';
                requiredAddDisplay.textContent = 'To add: 0';
                requiredAddDisplay.style.color = '#fff';
                requiredAddDisplay.style.fontWeight = '600';
                requiredAddDisplay.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)';
                headerRow.appendChild(requiredAddDisplay);

                const yourAddedDisplay = document.createElement('div');
                yourAddedDisplay.id = 'yourAddedDisplay';
                yourAddedDisplay.textContent = 'You added: 0';
                yourAddedDisplay.style.color = '#fff';
                yourAddedDisplay.style.fontWeight = '600';
                yourAddedDisplay.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)';
                headerRow.appendChild(yourAddedDisplay);

                // chips widget moved to bottom-left; created via ensureYourChipsContainer()

                numberContainer.appendChild(headerRow);

                const display = document.createElement('div');
                display.id = 'numberDisplay';
                display.textContent = String(game.value != null ? game.value : (game.state && game.state.value != null ? game.state.value : 0));
                display.style.fontSize = '64px';
                display.style.fontWeight = '700';
                display.style.width = '240px';
                display.style.textAlign = 'center';
                display.style.border = '3px solid #d4af37';
                display.style.borderRadius = '12px';
                display.style.padding = '24px';
                display.style.background = 'rgba(255,255,255,0.95)';
                display.style.color = '#0a5a2e';
                display.style.boxShadow = '0 8px 24px rgba(0,0,0,0.3)';
                numberContainer.appendChild(display);

                // create controls overlay (bottom-center) and attach inputs there
                removeControlsOverlay();
                const controlsOverlay = document.createElement('div');
                controlsOverlay.id = 'controlsOverlay';
                controlsOverlay.style.position = 'fixed';
                controlsOverlay.style.bottom = '20px';
                controlsOverlay.style.left = '50%';
                controlsOverlay.style.transform = 'translateX(-50%)';
                controlsOverlay.style.display = 'flex';
                controlsOverlay.style.gap = '12px';
                controlsOverlay.style.alignItems = 'center';
                controlsOverlay.style.padding = '12px 16px';
                controlsOverlay.style.background = 'rgba(255,255,255,0.95)';
                controlsOverlay.style.borderRadius = '12px';
                controlsOverlay.style.boxShadow = '0 8px 24px rgba(0,0,0,0.3)';
                controlsOverlay.style.zIndex = '1000';

                const input = document.createElement('input');
                input.type = 'number';
                input.id = 'addInput';
                input.placeholder = 'Amount';
                input.style.width = '140px';
                input.style.fontSize = '16px';
                input.step = '1';
                input.min = '1';

                const addBtn = document.createElement('button');
                addBtn.id = 'addBtn';
                addBtn.textContent = 'Add';
                    addBtn.addEventListener('click', () => {
                        const v = Number(input.value);
                        if (Number.isNaN(v) || !Number.isInteger(v) || v <= 0) { showError('Enter a whole number greater than 0'); return; }
                    const payLoad = {
                        method: 'add',
                        clientId: clientId,
                        gameId: response.gameId || gameId,
                        value: v,
                        name: username
                    };
                    amountAdded = (amountAdded || 0) + v;
                    ws.send(JSON.stringify(payLoad));
                });

                const checkBtn = document.createElement('button');
                checkBtn.id = 'checkBtn';
                checkBtn.textContent = 'Check';
                checkBtn.addEventListener('click', () => {
                    const payLoad = {
                        method: 'add',
                        clientId: clientId,
                        gameId: response.gameId || gameId,
                        value: 0,
                        name: username
                    };
                    ws.send(JSON.stringify(payLoad));
                });

                const foldBtn = document.createElement('button');
                foldBtn.id = 'foldBtn';
                foldBtn.textContent = 'Fold';
                foldBtn.addEventListener('click', () => {
                    const payLoad = { method: 'fold', clientId: clientId, gameId: response.gameId || gameId };
                    ws.send(JSON.stringify(payLoad));
                });

                controlsOverlay.appendChild(input);
                controlsOverlay.appendChild(addBtn);
                controlsOverlay.appendChild(checkBtn);
                controlsOverlay.appendChild(foldBtn);
                document.body.appendChild(controlsOverlay);
                // create cards area above controls (your cards) with label
                removeCardsOverlay();
                const cardsOverlay = document.createElement('div');
                cardsOverlay.id = 'cardsOverlay';
                cardsOverlay.style.position = 'fixed';
                cardsOverlay.style.bottom = '120px';
                cardsOverlay.style.left = '50%';
                cardsOverlay.style.transform = 'translateX(-50%)';
                cardsOverlay.style.display = 'flex';
                cardsOverlay.style.flexDirection = 'column';
                cardsOverlay.style.gap = '12px';
                cardsOverlay.style.alignItems = 'center';
                cardsOverlay.style.zIndex = '1100';
                // label
                const yourLabel = document.createElement('div');
                yourLabel.textContent = 'Your cards';
                yourLabel.style.fontWeight = '700';
                yourLabel.style.fontSize = '18px';
                yourLabel.style.color = '#fff';
                yourLabel.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
                yourLabel.style.marginBottom = '4px';
                cardsOverlay.appendChild(yourLabel);
                const cardsRow = document.createElement('div');
                cardsRow.style.display = 'flex';
                cardsRow.style.gap = '12px';
                cardsRow.id = 'cardsRow';
                cardsOverlay.appendChild(cardsRow);
                document.body.appendChild(cardsOverlay);

                if (Array.isArray(response.privateHand)) {
                    renderCards(response.privateHand);
                }
                // render community if present
                if (Array.isArray(game.community)){
                    ensureCommunityContainer();
                    renderCommunity(game.community, game.round);
                } else {
                    removeCommunityContainer();
                }

                divBoard.appendChild(numberContainer);
                // messages only for players in game (start always shows messages to players who joined)
                const amIInGameStart = Array.isArray(game.clients) && game.clients.some(c=>c.clientId===clientId);
                if (amIInGameStart) {
                    ensureMessagesContainer();
                    if (Array.isArray(game.messages)) renderMessages(game.messages);
                    // Only show turn indicator if game has started
                    if (game.started) {
                        updateTurnIndicator(game.currentTurnName || '');
                    } else {
                        removeTurnIndicator();
                    }
                    // reset local per-round counters on start as well
                    ensureYourChipsContainer();
                    updatePlayerList(game);
                    const sbIndexJoin = typeof game.smallBlindIndex === 'number' ? game.smallBlindIndex : null;
                    const bbIndexJoin = typeof game.bigBlindIndex === 'number' ? game.bigBlindIndex : null;
                    const sbIdJoin = (Array.isArray(game.clients) && sbIndexJoin !== null && game.clients[sbIndexJoin]) ? game.clients[sbIndexJoin].clientId : null;
                    const bbIdJoin = (Array.isArray(game.clients) && bbIndexJoin !== null && game.clients[bbIndexJoin]) ? game.clients[bbIndexJoin].clientId : null;
                    // Only show blind notices in first round
                    const currentRoundStart = typeof game.round === 'number' ? game.round : 0;
                    if (currentRoundStart <= 1) {
                        if (clientId === bbIdJoin) { showBlindNotice('You are the Big Blind'); }
                        else if (clientId === sbIdJoin) { showBlindNotice('You are the Small Blind'); }
                        else { clearBlindNotice(); }
                    } else {
                        clearBlindNotice();
                    }
                    const vElm = document.getElementById('yourChipsValue');
                    if (vElm) vElm.textContent = String((game.chips && typeof game.chips[clientId] === 'number') ? game.chips[clientId] : 0);
                    amountAdded = 0;
                    prevRound = game.round;
                } else {
                    removeMessagesContainer();
                    removeYourChipsContainer();
                }
            }

            //join
            if (response.method === "join"){
                const game = response.game;
                // switch to in-game screen when we receive a join payload
                showScreen('gameScreen');
                gameId = response.gameId || (game && game.id) || gameId;

                while(divPlayers.firstChild)
                    divPlayers.removeChild(divPlayers.firstChild)
                const di = document.createElement("div");
                    di.style.width = "200px";
                    di.style.background = "rgba(255,255,255,0.95)";
                    di.style.padding = "10px 16px";
                    di.style.borderRadius = "8px";
                    di.style.boxShadow = "0 4px 12px rgba(0,0,0,0.2)";
                    di.style.color = "#0a5a2e";
                    di.style.fontWeight = "600";
                    di.textContent = "current game code: " + (response.gameId || (game && game.id));
                    divPlayers.appendChild(di);
                // show chat once players have joined (even before the game starts)
                const amIInGameNow = Array.isArray(game.clients) && game.clients.some(c => c.clientId === clientId);
                if (amIInGameNow) {
                    ensureMessagesContainer();
                    if (Array.isArray(game.messages)) renderMessages(game.messages);
                    // Only show turn indicator if game has started
                    if (game.started) {
                        updateTurnIndicator(game.currentTurnName || '');
                    } else {
                        removeTurnIndicator();
                    }
                    ensureCommunityContainer();
                    if (Array.isArray(game.community)) renderCommunity(game.community, game.round);
                    ensureYourChipsContainer();
                    updatePlayerList(game);
                } else {
                    removeMessagesContainer();
                    removeCommunityContainer();
                    removeYourChipsContainer();
                }
                while(divBoard.firstChild)
                    divBoard.removeChild (divBoard.firstChild)
                removeControlsOverlay();

                // If the game hasn't started yet, show start button to creator, else show waiting text
                if (!game.started) {
                    // Remove any existing start button or waiting text
                    const existingStartBtn = document.getElementById('startGameButton');
                    const existingWaiting = document.getElementById('waitingForHost');
                    const existingGameCode = document.getElementById('gameCodeDisplay');
                    if (existingStartBtn) existingStartBtn.remove();
                    if (existingWaiting) existingWaiting.remove();
                    if (existingGameCode) existingGameCode.remove();
                    
                    // Get game code
                    const currentGameId = gameId || (game && game.id) || (response.gameId);
                    
                    // Create game code display
                    const gameCodeDisplay = document.createElement('div');
                    gameCodeDisplay.id = 'gameCodeDisplay';
                    gameCodeDisplay.textContent = 'Game Code: ' + currentGameId;
                    document.body.appendChild(gameCodeDisplay);
                    
                    if (game.creator === clientId) {
                        const startBtn = document.createElement('button');
                        startBtn.id = 'startGameButton';
                        startBtn.textContent = 'Start Game';
                        startBtn.addEventListener('click', () => {
                            const payLoad = {
                                method: 'start',
                                clientId: clientId,
                                gameId: gameId
                            };
                            ws.send(JSON.stringify(payLoad));
                        });
                        document.body.appendChild(startBtn);
                    } else {
                        const waiting = document.createElement('div');
                        waiting.id = 'waitingForHost';
                        waiting.textContent = 'Waiting for host to start';
                        document.body.appendChild(waiting);
                    }
                } else {
                    // Remove start button and waiting text when game starts
                    const existingStartBtn = document.getElementById('startGameButton');
                    const existingWaiting = document.getElementById('waitingForHost');
                    const existingGameCode = document.getElementById('gameCodeDisplay');
                    if (existingStartBtn) existingStartBtn.remove();
                    if (existingWaiting) existingWaiting.remove();
                    if (existingGameCode) existingGameCode.remove();
                    // Numeric game UI
                    const numberContainer = document.createElement('div');
                    numberContainer.style.display = 'flex';
                    numberContainer.style.flexDirection = 'column';
                    numberContainer.style.alignItems = 'center';
                    numberContainer.style.gap = '10px';

                    const display = document.createElement('div');
                    display.id = 'numberDisplay';
                    display.textContent = String(game.value != null ? game.value : (game.state && game.state.value != null ? game.state.value : 0));
                    display.style.fontSize = '64px';
                    display.style.fontWeight = '700';
                    display.style.width = '240px';
                    display.style.textAlign = 'center';
                    display.style.border = '3px solid #d4af37';
                    display.style.borderRadius = '12px';
                    display.style.padding = '24px';
                    display.style.background = 'rgba(255,255,255,0.95)';
                    display.style.color = '#0a5a2e';
                    display.style.boxShadow = '0 8px 24px rgba(0,0,0,0.3)';
                    numberContainer.appendChild(display);

                    const maxDisplay = document.createElement('div');
                    maxDisplay.id = 'maxDisplay';
                    maxDisplay.textContent = 0;
                    maxDisplay.style.fontSize = '14px';
                    maxDisplay.style.fontWeight = '600';
                    maxDisplay.style.width = '240px';
                    maxDisplay.style.textAlign = 'center';
                    maxDisplay.style.padding = '12px';
                    maxDisplay.style.color = '#fff';
                    maxDisplay.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)';
                    numberContainer.appendChild(maxDisplay);

                    // create controls overlay for joined-started view instead of inline controls
                    removeControlsOverlay();
                    const controlsOverlay2 = document.createElement('div');
                    controlsOverlay2.id = 'controlsOverlay';
                    controlsOverlay2.style.position = 'fixed';
                    controlsOverlay2.style.bottom = '20px';
                    controlsOverlay2.style.left = '50%';
                    controlsOverlay2.style.transform = 'translateX(-50%)';
                    controlsOverlay2.style.display = 'flex';
                    controlsOverlay2.style.gap = '12px';
                    controlsOverlay2.style.alignItems = 'center';
                    controlsOverlay2.style.padding = '12px 16px';
                    controlsOverlay2.style.background = 'rgba(255,255,255,0.95)';
                    controlsOverlay2.style.borderRadius = '12px';
                    controlsOverlay2.style.boxShadow = '0 8px 24px rgba(0,0,0,0.3)';
                    controlsOverlay2.style.zIndex = '1000';

                    const input2 = document.createElement('input');
                    input2.type = 'number';
                    input2.id = 'addInput';
                    input2.placeholder = 'Amount';
                    input2.style.width = '140px';
                    input2.style.fontSize = '16px';
                    input2.step = '1';
                    input2.min = '1';

                    const addBtn2 = document.createElement('button');
                    addBtn2.id = 'addBtn';
                    addBtn2.textContent = 'Add';
                        addBtn2.addEventListener('click', () => {
                            const v = Number(input2.value);
                            if (Number.isNaN(v) || !Number.isInteger(v) || v <= 0) { showError('Enter a whole number greater than 0'); return; }
                        const payLoad = {
                            method: 'add',
                            clientId: clientId,
                            gameId: gameId,
                            value: v,
                            name: username
                        };
                        ws.send(JSON.stringify(payLoad));
                    });

                    const checkBtn2 = document.createElement('button');
                    checkBtn2.id = 'checkBtn';
                    checkBtn2.textContent = 'Check';
                    checkBtn2.addEventListener('click', () => {
                        const payLoad = { method: 'add', clientId: clientId, gameId: gameId, value: 0, name: username };
                        ws.send(JSON.stringify(payLoad));
                    });

                    const foldBtn2 = document.createElement('button');
                    foldBtn2.textContent = 'Fold';
                    foldBtn2.addEventListener('click', () => {
                        ws.send(JSON.stringify({ method: 'fold', clientId: clientId, gameId: gameId }));
                    });

                    controlsOverlay2.appendChild(input2);
                    controlsOverlay2.appendChild(addBtn2);
                    controlsOverlay2.appendChild(checkBtn2);
                    controlsOverlay2.appendChild(foldBtn2);
                    document.body.appendChild(controlsOverlay2);
                    // create cards overlay above controls
                        removeCardsOverlay();
                        const cardsOverlay2 = document.createElement('div');
                        cardsOverlay2.id = 'cardsOverlay';
                        cardsOverlay2.style.position = 'fixed';
                        cardsOverlay2.style.bottom = '120px';
                        cardsOverlay2.style.left = '50%';
                        cardsOverlay2.style.transform = 'translateX(-50%)';
                        cardsOverlay2.style.display = 'flex';
                        cardsOverlay2.style.flexDirection = 'column';
                        cardsOverlay2.style.gap = '12px';
                        cardsOverlay2.style.alignItems = 'center';
                        cardsOverlay2.style.zIndex = '1100';
                        const yourLabel2 = document.createElement('div');
                        yourLabel2.textContent = 'Your cards';
                        yourLabel2.style.fontWeight = '700';
                        yourLabel2.style.fontSize = '18px';
                        yourLabel2.style.color = '#fff';
                        yourLabel2.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
                        yourLabel2.style.marginBottom = '4px';
                        cardsOverlay2.appendChild(yourLabel2);
                        const cardsRow2 = document.createElement('div');
                        cardsRow2.style.display = 'flex';
                        cardsRow2.style.gap = '8px';
                        cardsRow2.id = 'cardsRow';
                        cardsOverlay2.appendChild(cardsRow2);
                        document.body.appendChild(cardsOverlay2);
                    // render community for joined-started view
                    if (Array.isArray(game.community)){
                        ensureCommunityContainer();
                        renderCommunity(game.community, game.round);
                    } else {
                        removeCommunityContainer();
                    }

                    // add round/turn and amounts displays for joined-started view
                    const headerRow = document.createElement('div');
                    headerRow.style.display = 'flex';
                    headerRow.style.gap = '16px';
                    headerRow.style.flexWrap = 'wrap';
                    headerRow.style.justifyContent = 'center';
                    headerRow.style.padding = '12px';
                    headerRow.style.background = 'rgba(255,255,255,0.1)';
                    headerRow.style.borderRadius = '8px';
                    headerRow.style.marginBottom = '8px';

                    const roundDisplay2 = document.createElement('div');
                    roundDisplay2.id = 'roundDisplay';
                    roundDisplay2.textContent = 'Round: ' + (game.round || 0) + ' / ' + (game.totalRounds || 0);
                    roundDisplay2.style.color = '#fff';
                    roundDisplay2.style.fontWeight = '600';
                    roundDisplay2.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)';
                    headerRow.appendChild(roundDisplay2);

                    const turnDisplay2 = document.createElement('div');
                    turnDisplay2.id = 'turnDisplay';
                    turnDisplay2.textContent = 'Turn: ' + (game.currentTurnName || '');
                    turnDisplay2.style.color = '#fff';
                    turnDisplay2.style.fontWeight = '600';
                    turnDisplay2.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)';
                    headerRow.appendChild(turnDisplay2);

                    const requiredAddDisplay2 = document.createElement('div');
                    requiredAddDisplay2.id = 'requiredAddDisplay';
                    requiredAddDisplay2.textContent = 'To add: 0';
                    requiredAddDisplay2.style.color = '#fff';
                    requiredAddDisplay2.style.fontWeight = '600';
                    requiredAddDisplay2.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)';
                    headerRow.appendChild(requiredAddDisplay2);

                    const yourAddedDisplay2 = document.createElement('div');
                    yourAddedDisplay2.id = 'yourAddedDisplay';
                    yourAddedDisplay2.textContent = 'You added: 0';
                    yourAddedDisplay2.style.color = '#fff';
                    yourAddedDisplay2.style.fontWeight = '600';
                    yourAddedDisplay2.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)';
                    headerRow.appendChild(yourAddedDisplay2);

                    // chips widget moved to bottom-left; created via ensureYourChipsContainer()

                    numberContainer.insertBefore(headerRow, numberContainer.firstChild);

                    // render existing messages only if player is in game
                    const amIInGameJoin = Array.isArray(game.clients) && game.clients.some(c=>c.clientId===clientId);
                    if (amIInGameJoin) {
                        ensureMessagesContainer();
                        if (Array.isArray(game.messages)) renderMessages(game.messages);
                        // Only show turn indicator if game has started
                        if (game.started) {
                            updateTurnIndicator(game.currentTurnName || '');
                        } else {
                            removeTurnIndicator();
                        }
                    } else {
                        removeMessagesContainer();
                        removeTurnIndicator();
                    }

                    divBoard.appendChild(numberContainer);
                }




            }
        }

        function ensureMessagesContainer(){
            if (messagesContainer && document.body.contains(messagesContainer)) return;
            messagesContainer = document.createElement('div');
            messagesContainer.id = 'divMessages';
            messagesContainer.style.width = '300px';
            messagesContainer.style.maxHeight = '360px';
            messagesContainer.style.overflowY = 'auto';
            messagesContainer.style.border = '1px solid #ccc';
            messagesContainer.style.padding = '8px';
            messagesContainer.style.wordBreak = 'break-word';
            messagesContainer.style.position = 'fixed';
            messagesContainer.style.right = '20px';
            messagesContainer.style.top = '100px';
            messagesContainer.style.background = 'rgba(255,255,255,0.98)';
            messagesContainer.style.borderRadius = '12px';
            messagesContainer.style.border = '2px solid rgba(255,255,255,0.3)';
            messagesContainer.style.zIndex = '1000';
            messagesContainer.style.boxShadow = '0 8px 24px rgba(0,0,0,0.3)';
            document.body.appendChild(messagesContainer);
        }

        function removeMessagesContainer(){
            if (messagesContainer && messagesContainer.parentNode) {
                messagesContainer.parentNode.removeChild(messagesContainer);
            }
            messagesContainer = null;
        }

        // Turn indicator
        function ensureTurnIndicator(){
            if (document.getElementById('turnIndicator')) return;
            const d = document.createElement('div');
            d.id = 'turnIndicator';
            d.style.position = 'fixed';
            d.style.right = '20px';
            // Position below chat box: chat box is at top: 100px with maxHeight: 360px, so ends at 460px, add 10px gap
            d.style.top = '470px';
            d.style.background = 'rgba(255,255,255,0.98)';
            d.style.color = '#0a5a2e';
            d.style.padding = '10px 16px';
            d.style.borderRadius = '8px';
            d.style.border = '2px solid rgba(255,255,255,0.3)';
            d.style.fontWeight = '600';
            d.style.fontSize = '14px';
            d.style.zIndex = '1000';
            d.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            d.style.width = '300px';
            d.style.textAlign = 'center';
            d.textContent = 'Turn: -';
            document.body.appendChild(d);
        }

        function updateTurnIndicator(turnName){
            ensureTurnIndicator();
            const d = document.getElementById('turnIndicator');
            if (d) {
                d.textContent = 'Turn: ' + (turnName || '-');
            }
        }

        function removeTurnIndicator(){
            const existing = document.getElementById('turnIndicator');
            if (existing && existing.parentNode) {
                existing.parentNode.removeChild(existing);
            }
        }

        // error display
        let errorTimeout = null;
        function ensureErrorContainer(){
            if (document.getElementById('errorContainer')) return;
            const e = document.createElement('div');
            e.id = 'errorContainer';
            e.style.position = 'fixed';
            e.style.top = '20px';
            e.style.left = '50%';
            e.style.transform = 'translateX(-50%)';
            e.style.padding = '8px 12px';
            e.style.background = 'transparent';
            e.style.color = '#c00';
            e.style.fontWeight = '600';
            e.style.zIndex = '1100';
            document.body.appendChild(e);
        }

        function showError(msg, timeout = 4000){
            ensureErrorContainer();
            const e = document.getElementById('errorContainer');
            if (!e) return;
            e.textContent = msg;
            if (errorTimeout) clearTimeout(errorTimeout);
            if (timeout > 0) errorTimeout = setTimeout(()=>{ e.textContent = ''; }, timeout);
        }

        function clearError(){
            const e = document.getElementById('errorContainer');
            if (e) e.textContent = '';
            if (errorTimeout) { clearTimeout(errorTimeout); errorTimeout = null; }
        }

        function renderMessages(messages){
            if (!messagesContainer) return;
            while(messagesContainer.firstChild) messagesContainer.removeChild(messagesContainer.firstChild);
            messages.forEach(m => {
                const d = document.createElement('div');
                d.style.padding = '4px 0';
                // show only text (no timestamp)
                d.textContent = m.text;
                messagesContainer.appendChild(d);
            })
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeControlsOverlay(){
            const existing = document.getElementById('controlsOverlay');
            if (existing && existing.parentNode) existing.parentNode.removeChild(existing);
            removeCardsOverlay();
        }

        function removeCardsOverlay(){
            const existing = document.getElementById('cardsOverlay');
            if (existing && existing.parentNode) existing.parentNode.removeChild(existing);
        }

        // Track previous amounts to detect chip additions
        let previousAmounts = {};

        // Render poker table with players around it
        function renderPokerTable(game) {
            const container = document.getElementById('pokerTable');
            if (!container) return;
            
            // Clear previous content
            while(container.firstChild) container.removeChild(container.firstChild);
            
            // Create table surface
            const tableSurface = document.createElement('div');
            tableSurface.className = 'table-surface';
            container.appendChild(tableSurface);
            
            // Create pot display
            const potDisplay = document.createElement('div');
            potDisplay.className = 'table-pot';
            const potValue = typeof game.pot === 'number' ? game.pot : (typeof game.value === 'number' ? game.value : 0);
            potDisplay.textContent = 'Pot: ' + potValue;
            // Totals above pot: total added and total required
            const totals = document.createElement('div');
            totals.id = 'potTotals';
            totals.style.position = 'absolute';
            totals.style.left = '50%';
            totals.style.top = '40%';
            totals.style.transform = 'translate(-50%, -100%)';
            totals.style.display = 'flex';
            totals.style.flexDirection = 'column';
            totals.style.alignItems = 'center';
            totals.style.gap = '6px';
            totals.style.zIndex = '15';

            const totalAddedDisplay = document.createElement('div');
            totalAddedDisplay.id = 'totalAddedDisplay';
            totalAddedDisplay.style.color = '#fff';
            totalAddedDisplay.style.fontWeight = '700';
            totalAddedDisplay.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)';

            const totalRequiredDisplay = document.createElement('div');
            totalRequiredDisplay.id = 'totalRequiredDisplay';
            totalRequiredDisplay.style.color = '#ffd700';
            totalRequiredDisplay.style.fontWeight = '700';
            totalRequiredDisplay.style.textShadow = '1px 1px 2px rgba(0,0,0,0.5)';

            // compute totals
            const amounts = game.amountsAdded || {};
            let totalAdded = 0;
            Object.keys(amounts).forEach(k => { if (typeof amounts[k] === 'number') totalAdded += amounts[k]; });
            const target = typeof game.max === 'number' ? game.max : 0;
            const playersCount = Array.isArray(game.clients) ? game.clients.length : 0;
            const totalRequired = Math.max(0, target * playersCount - totalAdded);

            totalAddedDisplay.textContent = 'Total added: ' + totalAdded;
            totalRequiredDisplay.textContent = 'Total required: ' + totalRequired;

            totals.appendChild(totalAddedDisplay);
            totals.appendChild(totalRequiredDisplay);
            container.appendChild(totals);

            container.appendChild(potDisplay);
            
            // Get players list
            const players = Array.isArray(game.clients) ? game.clients : [];
            if (players.length === 0) return;
            
            // Find current player index
            const currentPlayerIndex = players.findIndex(p => p.clientId === clientId);
            
            // Find user index and reorder so user is always at position for bottom
            let playersOrdered = [...players];
            if (currentPlayerIndex >= 0) {
                // Move user to last position (bottom of table)
                const userPlayer = playersOrdered.splice(currentPlayerIndex, 1)[0];
                playersOrdered.push(userPlayer);
            }
            
            // Position players around oval table
            const numPlayers = playersOrdered.length;
            const tableWidth = 600;
            const tableHeight = 400;
            const centerX = tableWidth / 2;
            const centerY = tableHeight / 2;
            const radiusX = 200;
            const radiusY = 130;
            
            // Get current turn index (from original array)
            const turnIndex = typeof game.turnIndex === 'number' ? game.turnIndex : 0;
            const currentTurnClientId = players[turnIndex] ? players[turnIndex].clientId : null;
            
            // Separate user from other players
            const otherPlayers = playersOrdered.filter(p => p.clientId !== clientId);
            const userPlayer = playersOrdered.find(p => p.clientId === clientId);
            
            // Position other players around the top and sides (not bottom)
            otherPlayers.forEach((player, index) => {
                const seat = document.createElement('div');
                seat.className = 'player-seat';
                seat.id = 'player-seat-' + player.clientId;
                
                const playerName = player.name || player.clientId;
                seat.textContent = playerName;
                
                // Check if this is the current turn
                if (player.clientId === currentTurnClientId) {
                    seat.classList.add('current-turn');
                }
                
                // Check if chips were added
                if (game.amountsAdded && typeof game.amountsAdded[player.clientId] === 'number') {
                    const currentAmount = game.amountsAdded[player.clientId];
                    const prevAmount = previousAmounts[player.clientId] || 0;
                    if (currentAmount > prevAmount) {
                        seat.classList.add('chip-added');
                        setTimeout(() => {
                            seat.classList.remove('chip-added');
                        }, 600);
                    }
                }
                
                // Position around oval (top and sides only, not bottom)
                // Distribute players across 270 degrees (from -45 to 225 degrees, skipping bottom 90 degrees)
                const numOther = otherPlayers.length;
                const startAngle = -Math.PI / 4; // -45 degrees
                const endAngle = 5 * Math.PI / 4; // 225 degrees
                const angleRange = endAngle - startAngle;
                const angle = startAngle + (index / Math.max(1, numOther - 1)) * angleRange;
                
                const x = centerX + radiusX * Math.cos(angle) - 50;
                const y = centerY + radiusY * Math.sin(angle) - 20;
                seat.style.left = x + 'px';
                seat.style.top = y + 'px';
                
                container.appendChild(seat);
            });
            
            // Position user at bottom
            if (userPlayer) {
                const seat = document.createElement('div');
                seat.className = 'player-seat user-seat';
                seat.id = 'player-seat-' + userPlayer.clientId;
                
                const playerName = userPlayer.name || userPlayer.clientId || username;
                seat.textContent = playerName;
                
                // Check if this is the current turn
                if (userPlayer.clientId === currentTurnClientId) {
                    seat.classList.add('current-turn');
                }
                
                // Check if chips were added
                if (game.amountsAdded && typeof game.amountsAdded[userPlayer.clientId] === 'number') {
                    const currentAmount = game.amountsAdded[userPlayer.clientId];
                    const prevAmount = previousAmounts[userPlayer.clientId] || 0;
                    if (currentAmount > prevAmount) {
                        seat.classList.add('chip-added');
                        setTimeout(() => {
                            seat.classList.remove('chip-added');
                        }, 600);
                    }
                }
                
                seat.style.bottom = '20px';
                seat.style.left = '50%';
                seat.style.transform = 'translateX(-50%)';
                
                container.appendChild(seat);
            }
            
            // Update previous amounts
            if (game.amountsAdded) {
                previousAmounts = {...game.amountsAdded};
            }
        }

        // render player's private cards into cardsOverlay
        function renderCards(cards){
            const container = document.getElementById('cardsOverlay');
            if (!container) return;
            const cardsRow = document.getElementById('cardsRow') || container;
            while(cardsRow.firstChild) cardsRow.removeChild(cardsRow.firstChild);
            (cards || []).forEach(code => {
                // parse rank and suit from server code like 'AS', '10H', 'JD'
                if (!code) return;
                const suitChar = code.slice(-1).toUpperCase();
                const rank = code.slice(0, -1);
                const suitMap = { 'S': '', 'H': '', 'D': '', 'C': '' };
                const suitSym = suitMap[suitChar] || suitChar;
                const isRed = suitChar === 'H' || suitChar === 'D';

                const d = document.createElement('div');
                d.style.minWidth = '70px';
                d.style.width = '70px';
                d.style.height = '100px';
                d.style.border = '2px solid #333';
                d.style.borderRadius = '10px';
                d.style.display = 'flex';
                d.style.flexDirection = 'column';
                d.style.padding = '8px';
                d.style.background = 'linear-gradient(135deg, #ffffff 0%, #f8f8f8 100%)';
                d.style.boxShadow = '0 6px 16px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.8)';
                d.style.color = isRed ? '#d32f2f' : '#212121';
                d.style.fontFamily = 'Georgia, serif';
                d.style.transition = 'transform 0.2s, box-shadow 0.2s';
                d.style.cursor = 'default';

                const top = document.createElement('div');
                top.style.fontSize = '16px';
                top.style.fontWeight = '700';
                top.style.alignSelf = 'flex-start';
                top.style.lineHeight = '1';
                top.textContent = rank;

                const middle = document.createElement('div');
                middle.style.flex = '1';
                middle.style.display = 'flex';
                middle.style.alignItems = 'center';
                middle.style.justifyContent = 'center';
                middle.style.fontSize = '36px';
                middle.style.lineHeight = '1';
                middle.textContent = suitSym;

                const bottom = document.createElement('div');
                bottom.style.fontSize = '16px';
                bottom.style.fontWeight = '700';
                bottom.style.alignSelf = 'flex-end';
                bottom.style.lineHeight = '1';
                bottom.style.transform = 'rotate(180deg)';
                bottom.textContent = rank;

                d.appendChild(top);
                d.appendChild(middle);
                d.appendChild(bottom);
                cardsRow.appendChild(d);
            })
        }

        // community card area
        function ensureCommunityContainer(){
            if (document.getElementById('communityOverlay')) return;
            const c = document.createElement('div');
            c.id = 'communityOverlay';
            c.style.position = 'fixed';
            c.style.top = '42%';
            c.style.left = '50%';
            c.style.transform = 'translateX(-50%)';
            c.style.display = 'flex';
            c.style.flexDirection = 'column';
            c.style.gap = '8px';
            c.style.alignItems = 'center';
            c.style.zIndex = '1050';
            // label (text set by renderCommunity)
            const lbl = document.createElement('div');
            lbl.id = 'communityLabel';
            lbl.textContent = '';
            lbl.style.fontWeight = '700';
            lbl.style.fontSize = '20px';
            lbl.style.marginBottom = '8px';
            lbl.style.color = '#fff';
            lbl.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
            c.appendChild(lbl);
            const row = document.createElement('div');
            row.id = 'communityRow';
            row.style.display = 'flex';
            row.style.gap = '12px';
            c.appendChild(row);
            document.body.appendChild(c);
        }

        function removeCommunityContainer(){
            const existing = document.getElementById('communityOverlay');
            if (existing && existing.parentNode) existing.parentNode.removeChild(existing);
        }

        function ensureYourChipsContainer(){
            if (document.getElementById('yourChipsWidget')) return;
            const c = document.createElement('div');
            c.id = 'yourChipsWidget';
            c.style.position = 'fixed';
            c.style.left = '20px';
            c.style.bottom = '20px';
            c.style.display = 'flex';
            c.style.flexDirection = 'column';
            c.style.alignItems = 'center';
            c.style.gap = '8px';
            c.style.zIndex = '1200';
            c.style.background = 'rgba(255,255,255,0.98)';
            c.style.padding = '12px 16px';
            c.style.borderRadius = '12px';
            c.style.border = '2px solid rgba(212,175,55,0.3)';
            c.style.boxShadow = '0 8px 24px rgba(0,0,0,0.3)';
            // (Player list moved to a separate middle-left sidebar)
            const icon = document.createElement('div');
            icon.textContent = 'Your chips';
            icon.style.fontSize = '12px';
            icon.style.fontWeight = '600';
            icon.style.display = 'flex';
            icon.style.alignItems = 'center';
            icon.style.gap = '6px';
            const coin = document.createElement('span');
            coin.textContent = '';
            coin.style.fontSize = '14px';
            icon.insertBefore(coin, icon.firstChild);

            const val = document.createElement('div');
            val.id = 'yourChipsValue';
            val.textContent = '0';
            val.style.fontSize = '32px';
            val.style.fontWeight = '700';
            val.style.lineHeight = '1';

            c.appendChild(icon);
            c.appendChild(val);
            document.body.appendChild(c);
        }

        // Sidebar for player list (middle-left, above chips widget)
        function ensurePlayerListSidebar(){
            if (document.getElementById('playerListSidebar')) return;
            const s = document.createElement('div');
            s.id = 'playerListSidebar';
            s.style.position = 'fixed';
            s.style.left = '20px';
            s.style.top = '50%';
            s.style.transform = 'translateY(-50%)';
            s.style.zIndex = '1200';
            s.style.background = 'rgba(255,255,255,0.98)';
            s.style.padding = '12px 16px';
            s.style.borderRadius = '12px';
            s.style.border = '2px solid rgba(0,0,0,0.06)';
            s.style.boxShadow = '0 8px 24px rgba(0,0,0,0.3)';
            s.style.maxHeight = '60vh';
            s.style.overflowY = 'auto';
            // label
            const lbl = document.createElement('div');
            lbl.textContent = 'Players';
            lbl.style.fontSize = '12px';
            lbl.style.fontWeight = '700';
            lbl.style.color = '#0a5a2e';
            lbl.style.marginBottom = '8px';
            s.appendChild(lbl);
            const list = document.createElement('div');
            list.id = 'playerList';
            list.style.display = 'flex';
            list.style.flexDirection = 'column';
            list.style.gap = '6px';
            list.style.fontSize = '13px';
            list.style.color = '#0a5a2e';
            s.appendChild(list);
            document.body.appendChild(s);
        }
        
        function updatePlayerList(game) {
            ensurePlayerListSidebar();
            const playerList = document.getElementById('playerList');
            if (!playerList) return;
            
            while(playerList.firstChild) playerList.removeChild(playerList.firstChild);
            
            const players = Array.isArray(game.clients) ? game.clients : [];
            players.forEach(player => {
                const playerItem = document.createElement('div');
                playerItem.textContent = player.name || player.clientId;
                playerItem.style.padding = '2px 0';
                playerList.appendChild(playerItem);
            });
        }

        function removeYourChipsContainer(){
            const existing = document.getElementById('yourChipsWidget');
            if (existing && existing.parentNode) existing.parentNode.removeChild(existing);
        }

        // blind notice (shows "Small Blind" / "Big Blind" to the local blind player)
        let _blindNoticeTimeout = null;
        function ensureBlindNotice(){
            if (document.getElementById('blindNotice')) return;
            const d = document.createElement('div');
            d.id = 'blindNotice';
            d.style.position = 'fixed';
            d.style.bottom = '20px';
            d.style.right = '20px';
            d.style.background = 'linear-gradient(135deg, #ffd700 0%, #ffed4e 100%)';
            d.style.color = '#0a5a2e';
            d.style.padding = '12px 20px';
            d.style.border = '2px solid #ffb800';
            d.style.borderRadius = '10px';
            d.style.fontWeight = '700';
            d.style.fontSize = '16px';
            d.style.zIndex = '1300';
            d.style.boxShadow = '0 8px 24px rgba(255,184,0,0.5)';
            d.style.display = 'none';
            document.body.appendChild(d);
        }

        function showBlindNotice(text, timeout = 4000){
            ensureBlindNotice();
            const d = document.getElementById('blindNotice');
            if (!d) return;
            d.textContent = text;
            d.style.display = 'block';
            if (_blindNoticeTimeout) clearTimeout(_blindNoticeTimeout);
            if (timeout > 0) _blindNoticeTimeout = setTimeout(()=>{ d.style.display = 'none'; _blindNoticeTimeout = null; }, timeout);
        }

        function clearBlindNotice(){
            const d = document.getElementById('blindNotice');
            if (d) d.style.display = 'none';
            if (_blindNoticeTimeout) { clearTimeout(_blindNoticeTimeout); _blindNoticeTimeout = null; }
        }

        function renderCommunity(cards, round){
            const container = document.getElementById('communityOverlay');
            if (!container) return;
            const row = document.getElementById('communityRow');
            const lbl = document.getElementById('communityLabel');
            if (!row || !lbl) return;
            // show the label only when there are community cards OR at the start of round 2+
            const hasCards = Array.isArray(cards) && cards.length > 0;
            const showLabel = hasCards || (typeof round === 'number' && round >= 2);
            lbl.textContent = showLabel ? 'River' : '';
            lbl.style.color = '#fff';
            lbl.style.fontSize = '20px';
            lbl.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
            while(row.firstChild) row.removeChild(row.firstChild);
            (cards || []).forEach(code => {
                if (!code) return;
                const suitChar = code.slice(-1).toUpperCase();
                const rank = code.slice(0, -1);
                const suitMap = { 'S': '', 'H': '', 'D': '', 'C': '' };
                const suitSym = suitMap[suitChar] || suitChar;
                const isRed = suitChar === 'H' || suitChar === 'D';

                const d = document.createElement('div');
                d.style.minWidth = '70px';
                d.style.width = '70px';
                d.style.height = '100px';
                d.style.border = '2px solid #333';
                d.style.borderRadius = '10px';
                d.style.display = 'flex';
                d.style.flexDirection = 'column';
                d.style.padding = '8px';
                d.style.background = 'linear-gradient(135deg, #ffffff 0%, #f8f8f8 100%)';
                d.style.boxShadow = '0 6px 16px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.8)';
                d.style.color = isRed ? '#d32f2f' : '#212121';
                d.style.fontFamily = 'Georgia, serif';
                d.style.transition = 'transform 0.2s, box-shadow 0.2s';
                d.style.cursor = 'default';

                const top = document.createElement('div');
                top.style.fontSize = '16px';
                top.style.fontWeight = '700';
                top.style.alignSelf = 'flex-start';
                top.style.lineHeight = '1';
                top.textContent = rank;

                const middle = document.createElement('div');
                middle.style.flex = '1';
                middle.style.display = 'flex';
                middle.style.alignItems = 'center';
                middle.style.justifyContent = 'center';
                middle.style.fontSize = '36px';
                middle.style.lineHeight = '1';
                middle.textContent = suitSym;

                const bottom = document.createElement('div');
                bottom.style.fontSize = '16px';
                bottom.style.fontWeight = '700';
                bottom.style.alignSelf = 'flex-end';
                bottom.style.lineHeight = '1';
                bottom.style.transform = 'rotate(180deg)';
                bottom.textContent = rank;

                d.appendChild(top);
                d.appendChild(middle);
                d.appendChild(bottom);
                row.appendChild(d);
            })
        }

        
    </script>
</body>
</html>
